---

title: FastAPI


keywords: fastai
sidebar: home_sidebar

summary: "Recipes for FastAPI"
description: "Recipes for FastAPI"
nb_path: "nbs/05_build_and_deploy_data_apps/fastapi.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_build_and_deploy_data_apps/fastapi.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Basics">Basics<a class="anchor-link" href="#Basics"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-app.py">Create <code>app.py</code><a class="anchor-link" href="#Create-app.py"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Hello World!&#39;</span><span class="p">}</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Add-model-and-create-an-endpoint">Add model and create an endpoint<a class="anchor-link" href="#Add-model-and-create-an-endpoint"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">pipeline</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">(</span><span class="s1">&#39;sentiment-analysis&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/predict&#39;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="n">q</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">model</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-endpoints">Test endpoints<a class="anchor-link" href="#Test-endpoints"> </a></h3><ul>
<li>If testing in Jupyter, you will need to run this first:</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">nest_asyncio</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Then test using the <code>TestClient</code></li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastapi.testclient</span> <span class="kn">import</span> <span class="n">TestClient</span>

<span class="k">def</span> <span class="nf">test_sentiment</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/predict?q=</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sentiment</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">sentiment</span>
    
<span class="k">assert</span> <span class="n">test_sentiment</span><span class="p">(</span><span class="s1">&#39;Ice cream is delicious&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;POSITIVE&#39;</span>
<span class="k">assert</span> <span class="n">test_sentiment</span><span class="p">(</span><span class="s1">&#39;Papaya is gross&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NEGATIVE&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>You can also spin up the actual server to test from the browser via jupyter:</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">uvicorn</span>
<span class="n">uvicorn</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>...or shell:<div class="highlight"><pre><span></span>uvicorn app:app --reload
</pre></div>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Deploy">Deploy<a class="anchor-link" href="#Deploy"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-docker-image">Create docker image<a class="anchor-link" href="#Create-docker-image"> </a></h3><ol>
<li><p>In <code>Dockerfile</code>:</p>
<div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">tiangolo/uvicorn-gunicorn-fastapi:python3.7</span>

 COPY ./app /app
</pre></div>
</li>
<li><p>Create a directory called <code>app</code> and add the <code>app.py</code> from above</p>
<div class="highlight"><pre><span></span>mkdir app
 mv app.py app/app.py
</pre></div>
</li>
<li><p>Build the container</p>
<div class="highlight"><pre><span></span>docker build -t model_app
</pre></div>
</li>
<li><p>Test the container</p>
<div class="highlight"><pre><span></span>docker run -d --name my_model_app -p <span class="m">80</span>:80 model_app
</pre></div>
</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Deploy-with-Compose">Deploy with Compose<a class="anchor-link" href="#Deploy-with-Compose"> </a></h3><div class="highlight"><pre><span></span><span class="c1"># docker-compose.yml</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3.8</span>
<span class="nt">services</span><span class="p">:</span>
    <span class="nt">fastapi</span><span class="p">:</span>
        <span class="nt">ports</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">80:80</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Deploy-with-Kubernetes">Deploy with Kubernetes<a class="anchor-link" href="#Deploy-with-Kubernetes"> </a></h3><p>Generated from kompose</p>
<div class="highlight"><pre><span></span><span class="c1"># fastapi-deployment.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">kompose.cmd</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kompose convert</span>
    <span class="nt">kompose.version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.22.0 (955b78124)</span>
<span class="nt">creationTimestamp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="nt">labels</span><span class="p">:</span>
    <span class="nt">io.kompose.service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
    <span class="nt">io.kompose.service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
<span class="nt">strategy</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
<span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
    <span class="nt">annotations</span><span class="p">:</span>
        <span class="nt">kompose.cmd</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kompose convert</span>
        <span class="nt">kompose.version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.22.0 (955b78124)</span>
    <span class="nt">creationTimestamp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
    <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">io.kompose.service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
    <span class="nt">spec</span><span class="p">:</span>
    <span class="nt">containers</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
        <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
        <span class="nt">ports</span><span class="p">:</span>
            <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
    <span class="nt">restartPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="nt">status</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># fastapi-service.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">annotations</span><span class="p">:</span>
    <span class="nt">kompose.cmd</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kompose convert</span>
    <span class="nt">kompose.version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.22.0 (955b78124)</span>
<span class="nt">creationTimestamp</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="nt">labels</span><span class="p">:</span>
    <span class="nt">io.kompose.service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&quot;80&quot;</span>
    <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="nt">selector</span><span class="p">:</span>
    <span class="nt">io.kompose.service</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">fastapi</span>
<span class="nt">status</span><span class="p">:</span>
<span class="nt">loadBalancer</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</pre></div>

</div>
</div>
</div>
</div>
 

