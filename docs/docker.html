---

title: Docker


keywords: fastai
sidebar: home_sidebar

summary: "Recipes for Docker"
description: "Recipes for Docker"
nb_path: "nbs/01_linux_servers_networking/docker.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_linux_servers_networking/docker.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-your-own-registry">Create your own registry<a class="anchor-link" href="#Create-your-own-registry"> </a></h2><ul>
<li>docker/registry</li>
<li>linuxserver/fleet</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Multi-Stage-Builds">Multi-Stage Builds<a class="anchor-link" href="#Multi-Stage-Builds"> </a></h2><ul>
<li>Make your docker images smaller by separating concerns</li>
<li>Some of these features may require <code>DOCKER_BUILDKIT=1</code> env var</li>
<li>You can also use <code>docker buildx</code> to use BuildKit</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="DRY-/-Flavours">DRY / Flavours<a class="anchor-link" href="#DRY-/-Flavours"> </a></h3><ul>
<li>Parameterize with <code>ARG</code> to make slightly different envs
```Dockerfile
# or slim, buster, etc.
ARG flavour=alpine</li>
</ul>
<p>FROM python:3.8-$flavour
...
```</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Dev-Containers">Dev Containers<a class="anchor-link" href="#Dev-Containers"> </a></h3><ul>
<li>For max decoupling, you can create different containers with the same <code>Dockerfile</code> and specify which container to build by specifying <code>--target=$NAME</code></li>
</ul>
<div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">python:3.8-alpine</span> <span class="k">AS</span> <span class="s">build</span>
...

<span class="k">FROM</span> <span class="s">python:3.8-alpine</span> <span class="k">AS</span> <span class="s">dev</span>
<span class="k">COPY</span> --from<span class="o">=</span>build . .
<span class="c"># install only devtool stuff</span>
...

<span class="k">FROM</span> <span class="s">python:3.8-alpine</span> <span class="k">AS</span> <span class="s">release</span>
<span class="k">COPY</span> --from<span class="o">=</span>build app.py .
<span class="c"># no devtools, just the minimum required to deploy</span>
<span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;python app.py&quot;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Concurrent-Builds">Concurrent Builds<a class="anchor-link" href="#Concurrent-Builds"> </a></h3><ul>
<li>Instead of building linearly, you can treat build steps as a DAG and build in parallel where possible using multiple <code>COPY</code> statements</li>
</ul>
<div class="highlight"><pre><span></span>...
<span class="k">COPY</span> --from<span class="o">=</span>builder-dep-one   /out .
<span class="k">COPY</span> --from-builder-dep-two   /out .
<span class="k">COPY</span> --from-builder-dep-three /out .
...
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Secrets-and-keys">Secrets and keys<a class="anchor-link" href="#Secrets-and-keys"> </a></h3><ul>
<li>Do not add secrets with <code>ENV</code> or <code>ARG</code> or keys with <code>COPY</code> as they can be leaked</li>
<li>Instead, mount secrets and keys.
```Dockerfile
RUN --mount=type=secret,required,id=aws,target=.aws/credentials \
  ./get_model_from_s3.sh </li>
</ul>
<p>RUN --mount=type=ssh,required \
    git clone git@github.com:{org}/{repo}
```</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Compose-with-Multi-Stage">Compose with Multi-Stage<a class="anchor-link" href="#Compose-with-Multi-Stage"> </a></h3><ul>
<li>Specify which target you are building from the <code>Dockerfile</code></li>
</ul>

<pre><code>yml
# docker-compose.yml
services:
  app:
    build:
      context: ./
      target: ${ENVIRON}  # dev, prod, etc.</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Auto-build-containers-on-push-(GitHub-Actions)">Auto-build containers on push (GitHub Actions)<a class="anchor-link" href="#Auto-build-containers-on-push-(GitHub-Actions)"> </a></h2><ul>
<li>See example here: <a href="https://github.com/andrewtruong/autobuildtest">https://github.com/andrewtruong/autobuildtest</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create 3 files inside the container folder (in this case <code>jax</code>):</p>
<div class="highlight"><pre><span></span><span class="c"># jax/Dockerfile</span>
<span class="k">FROM</span> <span class="s">mambaorg/micromamba:0.11.3</span>

<span class="k">COPY</span> env.yml /root/env.yml
<span class="k">RUN</span> micromamba install -y -n base -f /root/env.yml <span class="o">&amp;&amp;</span> <span class="se">\</span>
    micromamba clean -a -y
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># jax/build.sh</span>
docker build -t itsandrewtruong/jax:latest -f Dockerfile .
</pre></div>
<div class="highlight"><pre><span></span><span class="c1"># jax/env.yml (from conda export &gt; env.yml)</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jax</span>
<span class="nt">channels</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">conda-forge</span>
<span class="nt">dependencies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">python&gt;=3.7</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jax</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">jaxlib</span>
  <span class="c1"># - cudnn  # not required if using nvidia-docker</span>
  <span class="c1"># - cudatoolkit</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li><p>Define <code>build.yml</code></p>
<div class="highlight"><pre><span></span><span class="c1"># .github/workflows/build.yml</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build Containers</span>
<span class="nt">on</span><span class="p">:</span>
<span class="nt">push</span><span class="p">:</span>
  <span class="nt">branches</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">master</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="nt">jax</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build docker containers</span>
  <span class="nt">runs-on</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
  <span class="nt">steps</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Checkout repo</span>
      <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>

    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Set up QEMU</span>  <span class="c1"># For ARM support (M1)</span>
      <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/setup-qemu-action@v1</span>

    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Set up Docker Buildx</span>
      <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/setup-buildx-action@v1</span>

    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Login to DockerHub</span>
      <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/login-action@v1</span>
      <span class="nt">with</span><span class="p">:</span>
        <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKERHUB_USERNAME }}</span>
        <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${{ secrets.DOCKERHUB_TOKEN }}</span>

    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Build and push</span>
      <span class="nt">id</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker_build</span>
      <span class="nt">uses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">docker/build-push-action@v2</span>
      <span class="nt">with</span><span class="p">:</span>
        <span class="nt">context</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">jax</span>
        <span class="nt">push</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="nt">tags</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">itsandrewtruong/jax:latest</span>

    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Image digest</span>
      <span class="nt">run</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">echo ${{ steps.docker_build.outputs.digest }}</span>
</pre></div>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup-Credential-Store">Setup Credential Store<a class="anchor-link" href="#Setup-Credential-Store"> </a></h2><ul>
<li><a href="https://github.com/docker/docker-credential-helpers/releases">https://github.com/docker/docker-credential-helpers/releases</a></li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Useful-Commands">Useful Commands<a class="anchor-link" href="#Useful-Commands"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="nb">alias</span> <span class="nv">dcu</span><span class="o">=</span><span class="s1">&#39;sudo docker-compose up -d&#39;</span>                   <span class="c1"># Start all services in background</span>
<span class="nb">alias</span> <span class="nv">dcd</span><span class="o">=</span><span class="s1">&#39;sudo docker-compose down --remove-orphans&#39;</span>   <span class="c1"># Destroy all services</span>
<span class="nb">alias</span> <span class="nv">dcp</span><span class="o">=</span><span class="s1">&#39;sudo docker-compose ps&#39;</span>                      <span class="c1"># Show port mappings</span>
<span class="nb">alias</span> <span class="nv">dcr</span><span class="o">=</span><span class="s1">&#39;dcd &amp;&amp; dcu&#39;</span>                                  <span class="c1"># Restart all services in background</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Check-logs">Check logs<a class="anchor-link" href="#Check-logs"> </a></h3><p><code>sudo docker-compose logs container1 container2</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Inspect-containers-(low-level)">Inspect containers (low level)<a class="anchor-link" href="#Inspect-containers-(low-level)"> </a></h3><p><code>sudo docker inspect container</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Enter-shell-in-container">Enter shell in container<a class="anchor-link" href="#Enter-shell-in-container"> </a></h3><p><code>sudo docker exec -it container</code> /bin/sh</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Run-from-another-directory">Run from another directory<a class="anchor-link" href="#Run-from-another-directory"> </a></h3><div class="highlight"><pre><span></span>docker compose -f /path/to/docker-compose.yml up
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Kompose">Kompose<a class="anchor-link" href="#Kompose"> </a></h2><ul>
<li>Convert <code>docker-compose.yml</code> to kubernetes files.</li>
<li>Compose files are easier to read and write imo</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Convert-docker-compose.yml">Convert <code>docker-compose.yml</code><a class="anchor-link" href="#Convert-docker-compose.yml"> </a></h3><ul>
<li>Optionally create helm chart with <code>-c</code></li>
<li>Auto-generated services are not guaranteed to work.<ul>
<li>You may need to create <code>ConfigMap</code> and <code>Secrets</code> to fill in what would otherwise go in <code>.env</code></li>
<li>Databases should not be used with kompose because <code>StatefulSet</code> is not available atm.</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="nv">SERVICE_NAME</span><span class="o">=</span><span class="s1">&#39;myapp&#39;</span>
mkdir <span class="nv">$SERVICE_NAME</span>

kompose convert -o <span class="nv">$SERVICE_NAME</span> -c
</pre></div>

</div>
</div>
</div>
</div>
 

